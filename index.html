<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>オイル交換予約</title>
    <script
      charset="utf-8"
      src="https://static.line-scdn.net/liff/edge/2/sdk.js"
    ></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }
      .container {
        max-width: 500px;
        margin: 0 auto;
        background: #fff;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        margin-bottom: 10px;
        font-size: 24px;
      }
      .subtitle {
        color: #666;
        margin-bottom: 30px;
        font-size: 14px;
      }
      .form-group {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 600;
        font-size: 14px;
      }
      input[type="text"],
      input[type="tel"],
      input[type="date"] {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
      }
      input:focus {
        outline: none;
        border-color: #667eea;
      }
      .radio-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .radio-item {
        display: flex;
        align-items: center;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
      }
      .radio-item:hover {
        border-color: #667eea;
        background: #f8f9ff;
      }
      .radio-item input[type="radio"] {
        margin-right: 10px;
        width: 20px;
        height: 20px;
      }
      .submit-btn {
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        border: none;
        border-radius: 10px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
        margin-top: 30px;
      }
      .submit-btn:hover {
        transform: translateY(-2px);
      }
      .submit-btn:active {
        transform: translateY(0);
      }
      .submit-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .loading {
        display: none;
        text-align: center;
        color: #667eea;
        margin-top: 20px;
      }
      .error-message {
        color: #e74c3c;
        font-size: 14px;
        margin-top: 10px;
        display: none;
      }
      .ok {
        color: #10b981;
        font-size: 14px;
        margin-top: 10px;
        display: none;
      }

      /* --- モーダル --- */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .modal {
        width: min(92vw, 420px);
        background: #fff;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
        text-align: center;
      }
      .modal h2 {
        font-size: 20px;
        margin-bottom: 6px;
      }
      .modal p {
        color: #555;
        margin: 6px 0 18px;
      }
      .modal .btn {
        display: inline-block;
        padding: 12px 18px;
        border: 0;
        border-radius: 10px;
        background: #10b981;
        color: #fff;
        font-weight: 700;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🚗 オイル交換予約</h1>
      <p class="subtitle">必要事項を入力してください</p>

      <form id="reservationForm">
        <div class="form-group">
          <label for="name">お名前 *</label>
          <input
            type="text"
            id="name"
            name="name"
            required
            placeholder="山田太郎"
          />
        </div>

        <div class="form-group">
          <label for="phone">電話番号 *</label>
          <input
            type="tel"
            id="phone"
            name="phone"
            required
            placeholder="090-1234-5678"
          />
        </div>

        <div class="form-group">
          <label for="date">希望日 *</label>
          <input type="date" id="date" name="date" required />
        </div>

        <div class="form-group">
          <label>希望時間 *</label>
          <div class="radio-group">
            <label class="radio-item"
              ><input
                type="radio"
                name="time"
                value="10:00-12:00"
                required
              /><span>10:00 - 12:00</span></label
            >
            <label class="radio-item"
              ><input type="radio" name="time" value="13:00-15:00" /><span
                >13:00 - 15:00</span
              ></label
            >
            <label class="radio-item"
              ><input type="radio" name="time" value="15:00-17:00" /><span
                >15:00 - 17:00</span
              ></label
            >
          </div>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">
          予約する
        </button>

        <div class="loading" id="loading">送信中...</div>
        <div class="error-message" id="errorMessage"></div>
        <div class="ok" id="okMessage">
          予約を受付けました。まもなく画面を閉じます。
        </div>
      </form>
    </div>

    <!-- 送信完了モーダル -->
    <div class="modal-overlay" id="doneModal">
      <div class="modal">
        <h2>送信が完了しました</h2>
        <p>ご入力ありがとうございました。スタッフよりご連絡します。</p>
        <button class="btn" id="closeBtn">LINEに戻る</button>
      </div>
    </div>

    <script>
      // === 設定値 ===
      const LIFF_ID = "2008228464-G4Z2gDq3";
      const GAS_URL =
        "https://script.google.com/macros/s/AKfycbwrDVHWagh1naCgIIC_EgOBfva71PWv786tI47AISJP5FugMxa2XMf4R8iLv1WCW1dd/exec";

      let userId = "";

      // --- LIFF 初期化 ---
      (async function init() {
        try {
          await liff.init({ liffId: LIFF_ID });
          if (!liff.isLoggedIn()) {
            liff.login();
            return;
          }
          const idToken = liff.getDecodedIDToken?.();
          if (idToken?.sub) {
            userId = idToken.sub;
          } else {
            const p = await liff.getProfile();
            userId = p.userId || "";
          }
        } catch (err) {
          console.error("LIFF初期化エラー:", err);
          showError("LINEとの接続に失敗しました。時間をおいてお試しください。");
        }
      })();

      // --- 送信処理 ---
      document
        .getElementById("reservationForm")
        .addEventListener("submit", onSubmit);

      async function onSubmit(e) {
        e.preventDefault();
        toggleSubmitting(true);

        const formData = {
          name: document.getElementById("name").value.trim(),
          phone: document.getElementById("phone").value.trim(),
          date: document.getElementById("date").value,
          time:
            (document.querySelector('input[name="time"]:checked') || {})
              .value || "",
        };
        if (
          !formData.name ||
          !formData.phone ||
          !formData.date ||
          !formData.time
        ) {
          toggleSubmitting(false);
          return showError("未入力の項目があります。");
        }

        // 1) GASへ保存（no-cors）
        try {
          await fetch(GAS_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            mode: "no-cors",
            body: JSON.stringify({ userId, ...formData }),
          });
        } catch (e) {
          console.warn("GAS送信エラー:", e);
        }

        // 2) 可能ならトークへ確認メッセージ
        try {
          if (liff.isInClient()) {
            const fs = await liff.getFriendship();
            if (fs.friendFlag) {
              await liff.sendMessages([
                {
                  type: "text",
                  text:
                    `オイル交換のご予約を受け付けました。\n\n` +
                    `お名前：${formData.name}\n` +
                    `希望日：${formData.date}\n` +
                    `時間帯：${formData.time}\n\n` +
                    `スタッフより折り返しご連絡します。`,
                },
              ]);
            }
          }
        } catch (e) {
          console.warn("sendMessages エラー:", e);
        }

        // 3) モーダルを表示（ユーザーが押すまで閉じない）
        openDoneModal();
        toggleSubmitting(false);
      }

      // --- モーダル制御 ---
      function openDoneModal() {
        document.getElementById("doneModal").style.display = "flex";
        document.getElementById("okMessage").style.display = "block"; // 既存の完了テキストも表示
      }
      document.getElementById("closeBtn").addEventListener("click", () => {
        try {
          if (liff.isInClient()) liff.closeWindow();
        } catch (_) {}
      });

      // --- UI ヘルパ ---
      function toggleSubmitting(b) {
        document.getElementById("submitBtn").disabled = b;
        document.getElementById("loading").style.display = b ? "block" : "none";
        document.getElementById("errorMessage").style.display = "none";
        document.getElementById("okMessage").style.display = "none";
      }
      function showError(msg) {
        const e = document.getElementById("errorMessage");
        e.textContent = msg;
        e.style.display = "block";
      }
    </script>
  </body>
</html>
