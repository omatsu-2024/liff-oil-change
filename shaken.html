<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>è»Šæ¤œ æ¦‚ç®—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    <!-- LIFF SDK -->
    <script
      charset="utf-8"
      src="https://static.line-scdn.net/liff/edge/2/sdk.js"
    ></script>
    <script>
      window.LIFF_ID = "2008228464-kZBg7yrq";
    </script>
    <style>
      :root {
        --bg: #0f172a;
        --card: #ffffff;
        --muted: #64748b;
        --accent: #4f46e5;
        --ok: #10b981;
        --danger: #ef4444;
        --bd: #e5e7eb;
        --warning: #f59e0b;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: linear-gradient(135deg, #4f46e5 0%, #0ea5e9 100%);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          "Noto Sans JP", sans-serif;
        color: #0f172a;
      }
      .wrap {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
      }
      .grid {
        display: grid;
        gap: 16px;
      }
      .card {
        background: var(--card);
        border-radius: 18px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        padding: 18px;
      }
      .title {
        font-size: 22px;
        font-weight: 800;
        margin: 0 0 6px;
      }
      .sub {
        color: var(--muted);
        font-size: 13px;
        margin: 0 0 12px;
      }
      .row {
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr;
      }
      @media (min-width: 820px) {
        .row {
          grid-template-columns: 1fr 1fr;
        }
      }
      label small {
        color: var(--muted);
      }
      .field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .field input[type="number"],
      .field input[type="month"],
      .field input[type="date"],
      .field select {
        border: 2px solid var(--bd);
        border-radius: 10px;
        padding: 12px 12px;
        font-size: 16px;
        outline: none;
        transition: 0.15s;
      }
      .field input:focus,
      .field select:focus {
        border-color: var(--accent);
      }
      .box {
        border: 2px dashed var(--bd);
        border-radius: 12px;
        padding: 12px;
      }
      .opt {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px dashed var(--bd);
      }
      .opt:last-child {
        border-bottom: none;
      }
      .price {
        font-variant-numeric: tabular-nums;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        background: var(--accent);
        color: #fff;
        border: 0;
        border-radius: 12px;
        padding: 14px 16px;
        font-weight: 800;
        cursor: pointer;
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .btn.sec {
        background: #0ea5e9;
      }
      .btn.ghost {
        background: #fff;
        color: #111;
        border: 2px solid var(--bd);
      }
      .btn.success {
        background: var(--ok);
      }
      .btn.warn {
        background: #f59e0b;
      }
      .total {
        font-size: 26px;
        font-weight: 900;
      }
      .line {
        height: 1px;
        background: var(--bd);
        margin: 8px 0;
      }
      .muted {
        color: var(--muted);
      }
      .badge {
        display: inline-block;
        background: #eef2ff;
        color: #3730a3;
        padding: 3px 8px;
        border-radius: 999px;
        font-size: 12px;
      }
      .badge.warning {
        background: #fef3c7;
        color: #92400e;
      }
      .badge.danger {
        background: #fee2e2;
        color: #991b1b;
      }
      .badge.success {
        background: #d1fae5;
        color: #065f46;
      }
      .footer {
        color: #fff;
        opacity: 0.9;
        text-align: center;
        margin-top: 14px;
        font-size: 12px;
      }
      .highlight-box {
        background: #fef3c7;
        border: 2px solid #fbbf24;
        border-radius: 12px;
        padding: 16px;
        margin-top: 12px;
      }
      .big-number {
        font-size: 32px;
        font-weight: 900;
        color: var(--accent);
        margin: 8px 0;
      }
      .alert {
        background: #fee2e2;
        border: 2px solid #ef4444;
        border-radius: 12px;
        padding: 12px;
        margin-top: 12px;
        color: #991b1b;
      }
      .radio-group {
        display: flex;
        gap: 12px;
        margin-top: 8px;
        flex-wrap: wrap;
      }
      .radio-item {
        flex: 1;
        min-width: 180px;
        border: 2px solid var(--bd);
        border-radius: 10px;
        padding: 12px;
        cursor: pointer;
        transition: 0.2s;
        text-align: center;
      }
      .radio-item:hover {
        border-color: var(--accent);
        background: #f8f9ff;
      }
      .radio-item input {
        margin-right: 6px;
      }
      .info-box {
        background: #e0e7ff;
        border-radius: 10px;
        padding: 12px;
        margin-top: 8px;
        font-size: 14px;
      }

      /* ===== ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®åŒºåˆ‡ã‚Šï¼ˆè¦‹å‡ºã—ä»˜ãã®é£¾ã‚Šç·šï¼‰ ===== */
      .section-divider {
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 22px 0;
        color: #334155;
      }
      .section-divider::before,
      .section-divider::after {
        content: "";
        flex: 1;
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(0, 0, 0, 0.2),
          transparent
        );
      }
      .section-divider .label {
        background: #ffffffaa;
        backdrop-filter: saturate(140%) blur(2px);
        border: 1px solid #e5e7eb;
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 12px;
        font-weight: 700;
      }
      .card-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end;
        margin-top: 12px;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <!-- è»Šæ¤œæº€æœŸæ—¥ï¼šã‚«ãƒ¼ãƒ‰ -->
      <div class="card">
        <h1 class="title">ğŸ—“ï¸ è»Šæ¤œæº€æœŸæ—¥ ç™»éŒ²</h1>
        <p class="sub">
          ã€Œè»Šæ¤œè¨¼ã®æœ‰åŠ¹æœŸé™ã‚’ãã®ã¾ã¾å…¥åŠ›ã€ã¾ãŸã¯ã€Œåˆåº¦ç™»éŒ²ã‹ã‚‰è‡ªå‹•è¨ˆç®—ã€ã‚’é¸ã¹ã¾ã™ã€‚
        </p>

        <div class="grid">
          <!-- å…¥åŠ›æ–¹æ³•ã®é¸æŠ -->
          <div class="field">
            <label>å…¥åŠ›æ–¹æ³•ã‚’é¸ã¶</label>
            <div class="radio-group">
              <label class="radio-item"
                ><input type="radio" name="expMode" value="direct" checked />
                æœ‰åŠ¹æœŸé™æ—¥ã‚’ç›´æ¥å…¥åŠ›</label
              >
              <label class="radio-item"
                ><input type="radio" name="expMode" value="calc" />
                åˆåº¦ç™»éŒ²ã‹ã‚‰è‡ªå‹•è¨ˆç®—</label
              >
            </div>
          </div>

          <!-- ç›´æ¥å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ -->
          <div id="expDirectBox" class="field">
            <label>è»Šæ¤œè¨¼ã®æœ‰åŠ¹æœŸé™æ—¥</label>
            <input type="date" id="expiryDateDirect" />
            <div class="muted" style="font-size: 12px">
              è»Šæ¤œè¨¼ã®ã€Œæœ‰åŠ¹æœŸé–“ã®æº€äº†ã™ã‚‹æ—¥ã€ã‚’ãã®ã¾ã¾å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
            </div>
          </div>

          <!-- è‡ªå‹•è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰ -->
          <div id="expCalcBox" class="field" style="display: none">
            <div class="row">
              <div class="field">
                <label>åˆåº¦ç™»éŒ²ï¼ˆå¹´æœˆï¼‰ <small>ï¼ˆè»Šæ¤œè¨¼ã«è¨˜è¼‰ï¼‰</small></label>
                <input
                  type="month"
                  id="registrationDate"
                  placeholder="ä¾‹: 2021-04"
                />
              </div>
              <div class="field">
                <label>è»Šä¸¡ã‚¿ã‚¤ãƒ—</label>
                <div class="radio-group">
                  <label class="radio-item"
                    ><input type="radio" name="carType" value="new" checked />
                    æ–°è»Š</label
                  >
                  <label class="radio-item"
                    ><input type="radio" name="carType" value="used" />
                    ä¸­å¤ãƒ»ç¶™ç¶š</label
                  >
                </div>
                <div class="info-box">
                  <small
                    >æ–°è»Šï¼šåˆå›3å¹´ â†’ ä»¥å¾Œ2å¹´ã”ã¨<br />ä¸­å¤ãƒ»ç¶™ç¶šï¼šåˆå›ã‹ã‚‰2å¹´ã”ã¨</small
                  >
                </div>
              </div>
            </div>
            <div class="muted" id="calcPreview" style="margin-top: 6px"></div>
          </div>

          <div class="line"></div>

          <div
            style="
              display: flex;
              gap: 10px;
              align-items: center;
              flex-wrap: wrap;
            "
          >
            <button class="btn sec" id="btnPreviewExpiry">æº€æœŸæ—¥ã‚’è¡¨ç¤º</button>
            <button class="btn success" id="registerExpiryBtn">
              ğŸ“… è»Šæ¤œæ—¥ã‚’ç™»éŒ²ã—ã¦ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’å—ã‘å–ã‚‹
            </button>
            <span class="muted" id="expiryHint"></span>
          </div>

          <!-- è¨ˆç®—/ç›´æ¥å…¥åŠ›ã®çµæœè¡¨ç¤º -->
          <div id="expiryResult" style="display: none; margin-top: 8px">
            <div class="highlight-box">
              <div style="text-align: center">
                <div
                  class="badge warning"
                  style="font-size: 14px; margin-bottom: 8px"
                >
                  æ¬¡å›è»Šæ¤œæº€æœŸæ—¥
                </div>
                <div class="big-number" id="expiryDate">yyyyå¹´mæœˆdæ—¥</div>
                <div
                  id="daysRemaining"
                  class="muted"
                  style="font-size: 16px; margin-top: 4px"
                >
                  ã‚ã¨Næ—¥
                </div>
              </div>
            </div>
            <div id="alertBox" style="display: none" class="alert">
              âš ï¸ è»Šæ¤œæº€æœŸã¾ã§30æ—¥ã‚’åˆ‡ã£ã¦ã„ã¾ã™ï¼ãŠæ—©ã‚ã«ã”äºˆç´„ãã ã•ã„ã€‚
            </div>
          </div>
        </div>

        <!-- æº€æœŸæ—¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼šé–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ -->
        <div class="card-actions">
          <button class="btn ghost" id="closeExpiryBtn">ã‚¢ãƒ—ãƒªã‚’é–‰ã˜ã‚‹</button>
        </div>
      </div>

      <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³åŒºåˆ‡ã‚Š -->
      <div class="section-divider">
        <span class="label">è»Šæ¤œè²»ç”¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</span>
      </div>

      <!-- è»Šæ¤œè²»ç”¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼šã‚«ãƒ¼ãƒ‰ -->
      <div class="card">
        <h1 class="title">è»Šæ¤œ æ¦‚ç®—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
        <p class="sub">
          â€»æ¦‚ç®—ã®ç›®å®‰ã§ã™ã€‚æœ€æ–°ã®æ³•å®šè²»ç”¨ãƒ»åº—èˆ—ä¾¡æ ¼ã«åˆã‚ã›ã¦é‡‘é¡è¨­å®šã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚
        </p>

        <div class="grid row">
          <div class="field">
            <label
              >è»Šä¸¡åŒºåˆ† <small>ï¼ˆé‡é‡ç¨ãƒ»è‡ªè³ è²¬ãƒ»å°ç´™ã«åæ˜ ï¼‰</small></label
            >
            <select id="carClass">
              <option value="kei">è»½è‡ªå‹•è»Š</option>
              <option value="small">å°å‹ï¼ˆã€œ1.0tï¼‰</option>
              <option value="mid">ä¸­å‹ï¼ˆ1.0tã€œ1.5tï¼‰</option>
              <option value="large">å¤§å‹ï¼ˆ1.5tã€œ2.0tï¼‰</option>
              <option value="xl">ç‰¹å¤§ï¼ˆ2.0tã€œ2.5tï¼‰</option>
            </select>
          </div>
          <div class="field">
            <label
              >åˆåº¦ç™»éŒ²ã‹ã‚‰ã®çµŒéå¹´æ•° <small>ï¼ˆé‡é‡ç¨ã«å½±éŸ¿ï¼‰</small></label
            >
            <select id="ageYears">
              <option value="0-13">ã€œ13å¹´</option>
              <option value="13-18">13ã€œ18å¹´</option>
              <option value="18+">18å¹´ä»¥ä¸Š</option>
            </select>
          </div>
          <div class="field">
            <label>åº—èˆ— åŸºæœ¬ç‚¹æ¤œæ•´å‚™æ–™ï¼ˆä»»æ„ï¼‰</label>
            <input
              type="number"
              id="baseFee"
              inputmode="numeric"
              placeholder="ä¾‹: 19800"
              value="19800"
            />
          </div>
          <div class="field">
            <label>å‰²å¼•ï¼ˆä»»æ„ï¼‰<small> ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ç­‰</small></label>
            <input
              type="number"
              id="discount"
              inputmode="numeric"
              placeholder="ä¾‹: 1000"
              value="0"
            />
          </div>
        </div>

        <div class="box" style="margin-top: 12px">
          <div class="opt">
            <strong>ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ•´å‚™ï¼ˆä»»æ„ï¼‰</strong
            ><span class="muted">ãƒã‚§ãƒƒã‚¯ã§è¿½åŠ </span>
          </div>
          <div class="opt">
            <label
              ><input
                type="checkbox"
                class="optChk"
                data-label="ã‚¨ãƒ³ã‚¸ãƒ³ã‚ªã‚¤ãƒ«äº¤æ›"
                data-price="3500"
              />
              ã‚¨ãƒ³ã‚¸ãƒ³ã‚ªã‚¤ãƒ«äº¤æ›</label
            ><span class="price">Â¥3,500</span>
          </div>
          <div class="opt">
            <label
              ><input
                type="checkbox"
                class="optChk"
                data-label="ã‚ªã‚¤ãƒ«ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆäº¤æ›"
                data-price="1500"
              />
              ã‚ªã‚¤ãƒ«ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆäº¤æ›</label
            ><span class="price">Â¥1,500</span>
          </div>
          <div class="opt">
            <label
              ><input
                type="checkbox"
                class="optChk"
                data-label="ãƒ–ãƒ¬ãƒ¼ã‚­ãƒ•ãƒ«ãƒ¼ãƒ‰äº¤æ›"
                data-price="4500"
              />
              ãƒ–ãƒ¬ãƒ¼ã‚­ãƒ•ãƒ«ãƒ¼ãƒ‰äº¤æ›</label
            ><span class="price">Â¥4,500</span>
          </div>
          <div class="opt">
            <label
              ><input
                type="checkbox"
                class="optChk"
                data-label="å†·å´æ°´ï¼ˆLLCï¼‰äº¤æ›"
                data-price="6000"
              />
              å†·å´æ°´ï¼ˆLLCï¼‰äº¤æ›</label
            ><span class="price">Â¥6,000</span>
          </div>
          <div class="opt">
            <label
              ><input
                type="checkbox"
                class="optChk"
                data-label="ãƒ¯ã‚¤ãƒ‘ãƒ¼ã‚´ãƒ äº¤æ›"
                data-price="1200"
              />
              ãƒ¯ã‚¤ãƒ‘ãƒ¼ã‚´ãƒ äº¤æ›</label
            ><span class="price">Â¥1,200</span>
          </div>
          <div class="opt">
            <label
              ><input
                type="checkbox"
                class="optChk"
                data-label="ã‚¨ã‚¢ã‚³ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼äº¤æ›"
                data-price="3500"
              />
              ã‚¨ã‚¢ã‚³ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼äº¤æ›</label
            ><span class="price">Â¥3,500</span>
          </div>
        </div>

        <div class="grid row" style="margin-top: 14px">
          <div class="card" style="padding: 14px">
            <div class="badge">æ³•å®šè²»ç”¨ï¼ˆæ¦‚ç®—ï¼‰</div>
            <div id="legalBreakdown" class="grid" style="margin-top: 8px"></div>
            <div class="line"></div>
            <div class="grid" id="shopBreakdown"></div>
            <div class="line"></div>
            <div class="total price">åˆè¨ˆï¼š<span id="grandTotal">Â¥0</span></div>
            <div class="muted" id="note"></div>
          </div>
          <div class="card" style="padding: 14px">
            <div class="badge">è¦‹ç©ã‚Šãƒ¡ãƒ¢</div>
            <div
              id="summaryText"
              class="muted"
              style="white-space: pre-wrap; margin-top: 8px"
            ></div>
            <div
              class="grid"
              style="
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                margin-top: 10px;
              "
            >
              <button class="btn ghost" id="copyBtn">ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
              <button class="btn sec" id="sendBtn">LINEã«é€ã‚‹</button>
            </div>
          </div>
        </div>

        <div class="line" style="margin: 16px 0"></div>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px">
          <button class="btn" id="calcBtn">æ¦‚ç®—ã‚’è¨ˆç®—ã™ã‚‹</button>
          <button class="btn ghost" id="resetBtn">å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        </div>

        <!-- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼šé–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ -->
        <div class="card-actions">
          <button class="btn ghost" id="closeSimBtn">ã‚¢ãƒ—ãƒªã‚’é–‰ã˜ã‚‹</button>
        </div>
      </div>

      <p class="footer">
        â€»æœ¬ãƒ„ãƒ¼ãƒ«ã¯æ¦‚ç®—ã®ç›®å®‰ã§ã™ã€‚å®Ÿéš›ã®è²»ç”¨ã¯è»Šä¸¡çŠ¶æ…‹ãƒ»æ”¹å®šç­‰ã§å¤‰å‹•ã—ã¾ã™ã€‚åº—èˆ—ã®æç¤ºä¾¡æ ¼ã‚’å„ªå…ˆã—ã¦ãã ã•ã„ã€‚
      </p>
    </div>

    <script>
      /* ========================= è¨­å®šãƒ†ãƒ¼ãƒ–ãƒ« ========================= */
      const TABLES = {
        weightTax: {
          "0-13": {
            kei: 6600,
            small: 16400,
            mid: 24600,
            large: 32800,
            xl: 41000,
          },
          "13-18": {
            kei: 7600,
            small: 18900,
            mid: 28300,
            large: 37800,
            xl: 47200,
          },
          "18+": {
            kei: 8800,
            small: 25200,
            mid: 37800,
            large: 50400,
            xl: 63000,
          },
        },
        jibaiseki: { std: { kei: 17000, passenger: 17800 } },
        stamp: { std: { kei: 1800, passenger: 1600 } },
      };

      /* ========================= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========================= */
      const fmt = (n) => "Â¥" + Math.round(n).toLocaleString("ja-JP");
      const el = (s) => document.querySelector(s);
      const els = (s) => [...document.querySelectorAll(s)];
      function toast(msg, ok = true) {
        const n = document.createElement("div");
        n.textContent = msg;
        n.style.cssText = `position:fixed;left:50%;top:16px;transform:translateX(-50%);
          background:${ok ? "rgba(16,185,129,.95)" : "rgba(239,68,68,.95)"};
          color:#fff;padding:10px 14px;border-radius:999px;font-weight:700;
          z-index:9999;box-shadow:0 8px 24px rgba(0,0,0,.2);white-space:pre-line`;
        document.body.appendChild(n);
        setTimeout(() => n.remove(), 2000);
      }
      const fmtDateJP = (d) =>
        d
          ? d.toLocaleDateString("ja-JP", {
              year: "numeric",
              month: "long",
              day: "numeric",
            })
          : "";

      /* ========================= è»Šæ¤œæº€æœŸæ—¥ï¼šãƒ­ã‚¸ãƒƒã‚¯ ========================= */
      let calculatedExpiryDate = null;

      function updateExpiryModeUI() {
        const mode = document.querySelector(
          'input[name="expMode"]:checked'
        ).value;
        el("#expDirectBox").style.display = mode === "direct" ? "" : "none";
        el("#expCalcBox").style.display = mode === "calc" ? "" : "none";
        el("#expiryHint").textContent = "";
        el("#calcPreview").textContent = "";
        calculatedExpiryDate = null;
        el("#expiryResult").style.display = "none";
      }

      function nextShakenFromFirstReg(ymStr, isNewCar) {
        if (!ymStr) return null;
        const [y, m] = ymStr.split("-").map(Number);
        if (!y || !m) return null;
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        let candidate = new Date(y, m - 1, 1);
        candidate = new Date(
          candidate.getFullYear(),
          candidate.getMonth() + (isNewCar ? 36 : 24),
          0
        );
        while (candidate <= today) {
          candidate = new Date(
            candidate.getFullYear(),
            candidate.getMonth() + 24,
            0
          );
        }
        return candidate;
      }

      function previewExpiry() {
        const mode = document.querySelector(
          'input[name="expMode"]:checked'
        ).value;
        const hint = el("#expiryHint");
        const pv = el("#calcPreview");
        calculatedExpiryDate = null;
        hint.textContent = "";
        pv.textContent = "";

        if (mode === "direct") {
          const v = el("#expiryDateDirect").value;
          if (!v) {
            toast("æœ‰åŠ¹æœŸé™æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", false);
            return;
          }
          const d = new Date(v);
          if (isNaN(d.getTime())) {
            toast("æœ‰åŠ¹ãªæ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", false);
            return;
          }
          calculatedExpiryDate = d;
          hint.textContent = `æº€æœŸæ—¥ï¼š${fmtDateJP(d)}ï¼ˆç›´æ¥å…¥åŠ›ï¼‰`;
        } else {
          const ym = el("#registrationDate").value;
          const isNew =
            document.querySelector('input[name="carType"]:checked').value ===
            "new";
          if (!ym) {
            toast("åˆåº¦ç™»éŒ²ï¼ˆå¹´æœˆï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", false);
            return;
          }
          const d = nextShakenFromFirstReg(ym, isNew);
          if (!d) {
            toast("æº€æœŸæ—¥ã®è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸ", false);
            return;
          }
          calculatedExpiryDate = d;
          pv.textContent = `æ¬¡å›æº€æœŸæ—¥ï¼ˆè¨ˆç®—çµæœï¼‰ï¼š${fmtDateJP(d)}`;
          hint.textContent = `æº€æœŸæ—¥ï¼š${fmtDateJP(d)}ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰`;
        }
        showExpiryResult(calculatedExpiryDate);
      }

      function showExpiryResult(expiryDate) {
        if (!expiryDate) return;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const diffDays = Math.ceil(
          (expiryDate - today) / (1000 * 60 * 60 * 24)
        );
        el("#expiryDate").textContent = fmtDateJP(expiryDate);

        if (diffDays < 0) {
          el("#daysRemaining").innerHTML =
            '<span style="color:var(--danger);font-weight:bold">è»Šæ¤œãŒåˆ‡ã‚Œã¦ã„ã¾ã™ï¼</span>';
          el("#alertBox").style.display = "block";
          el("#alertBox").textContent =
            "ğŸš¨ è»Šæ¤œãŒåˆ‡ã‚Œã¦ã„ã¾ã™ï¼ã™ãã«ã”äºˆç´„ãã ã•ã„ã€‚";
        } else if (diffDays <= 30) {
          el(
            "#daysRemaining"
          ).innerHTML = `<span style="color:var(--warning);font-weight:bold">ã‚ã¨${diffDays}æ—¥</span>`;
          el("#alertBox").style.display = "block";
          el("#alertBox").textContent =
            "âš ï¸ è»Šæ¤œæº€æœŸã¾ã§30æ—¥ã‚’åˆ‡ã£ã¦ã„ã¾ã™ï¼ãŠæ—©ã‚ã«ã”äºˆç´„ãã ã•ã„ã€‚";
        } else {
          el("#daysRemaining").textContent = `ã‚ã¨${diffDays}æ—¥`;
          el("#alertBox").style.display = "none";
        }
        el("#expiryResult").style.display = "block";
      }

      async function registerExpiryDate() {
        if (!calculatedExpiryDate) {
          toast("å…ˆã«ã€Œæº€æœŸæ—¥ã‚’è¡¨ç¤ºã€ã§ç¢ºèªã—ã¦ãã ã•ã„", false);
          return;
        }
        if (!liffReady) {
          await initLiff();
          if (!liffReady) {
            toast("LIFFåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ", false);
            return;
          }
        }

        try {
          if (!liff.isInClient()) {
            toast("ã‚¹ãƒãƒ›ã®LINEã‚¢ãƒ—ãƒªã‹ã‚‰é–‹ã„ã¦ãã ã•ã„", false);
            return;
          }
          const profile = await liff.getProfile();
          const expiryDateStr = fmtDateJP(calculatedExpiryDate);
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const diffDays = Math.ceil(
            (calculatedExpiryDate - today) / (1000 * 60 * 60 * 24)
          );

          const message = `ã€è»Šæ¤œæº€æœŸæ—¥ ç™»éŒ²å®Œäº†ã€‘

ãŠåå‰: ${profile.displayName}
æ¬¡å›è»Šæ¤œæº€æœŸæ—¥: ${expiryDateStr}
æ®‹ã‚Šæ—¥æ•°: ${diffDays}æ—¥

è»Šæ¤œ30æ—¥å‰ã¨7æ—¥å‰ã«è‡ªå‹•ã§ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’ãŠé€ã‚Šã—ã¾ã™ğŸ“…
â€»ã“ã®æƒ…å ±ã¯åº—èˆ—å´ã§ç®¡ç†ã•ã‚Œã¾ã™`;

          await liff.sendMessages([{ type: "text", text: message }]);
          toast("è»Šæ¤œæº€æœŸæ—¥ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼", true);
          // â˜…è‡ªå‹•ã§é–‰ã˜ã¾ã›ã‚“ï¼ˆä»»æ„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ä¸‹ã®ã€Œã‚¢ãƒ—ãƒªã‚’é–‰ã˜ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼‰
        } catch (e) {
          console.error("ç™»éŒ²ã‚¨ãƒ©ãƒ¼:", e);
          let msg = "ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ";
          if (e?.message?.includes("invalid receiver")) {
            msg =
              "ã‚°ãƒ«ãƒ¼ãƒ—/è¤‡æ•°äººãƒˆãƒ¼ã‚¯ã‹ã‚‰ã¯é€ä¿¡ã§ãã¾ã›ã‚“ã€‚Botã¨ã®1å¯¾1ãƒˆãƒ¼ã‚¯ã‹ã‚‰é–‹ã„ã¦ãã ã•ã„ã€‚";
          } else if (/permission|scope/i.test(e?.message || "")) {
            msg =
              "chat_message.write æ¨©é™ãŒæœªä»˜ä¸ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆLIFFè¨­å®šã‚’ç¢ºèªï¼‰ã€‚";
          }
          toast(msg, false);
        }
      }

      /* ========================= è²»ç”¨è¨ˆç®—ï¼ˆæ—¢å­˜ï¼‰ ========================= */
      function calc() {
        const carClass = el("#carClass").value;
        const ageBand = el("#ageYears").value;
        const baseFee = +el("#baseFee").value || 0;
        const discount = +el("#discount").value || 0;

        const wt = TABLES.weightTax[ageBand][carClass];
        const jb =
          carClass === "kei"
            ? TABLES.jibaiseki.std.kei
            : TABLES.jibaiseki.std.passenger;
        const sp =
          carClass === "kei"
            ? TABLES.stamp.std.kei
            : TABLES.stamp.std.passenger;

        const options = els(".optChk")
          .filter((c) => c.checked)
          .map((c) => ({ label: c.dataset.label, price: +c.dataset.price }));
        const optTotal = options.reduce((a, b) => a + b.price, 0);

        const legalTotal = wt + jb + sp;
        const shopTotal = Math.max(0, baseFee - discount) + optTotal;
        const grand = legalTotal + shopTotal;

        renderBreakdown({
          wt,
          jb,
          sp,
          baseFee,
          discount,
          optTotal,
          options,
          legalTotal,
          shopTotal,
          grand,
        });
      }

      function renderBreakdown(d) {
        el("#legalBreakdown").innerHTML = `
          <div class="grid" style="grid-template-columns:1fr auto">
            <div>è‡ªè³ è²¬ï¼ˆ24ã‹æœˆï¼‰</div><div class="price">${fmt(d.jb)}</div>
            <div>é‡é‡ç¨ï¼ˆæ¦‚ç®—ï¼‰</div><div class="price">${fmt(d.wt)}</div>
            <div>å°ç´™ä»£ï¼ˆæ¦‚ç®—ï¼‰</div><div class="price">${fmt(d.sp)}</div>
          </div>`;

        const optsHtml = d.options.length
          ? d.options
              .map(
                (o) =>
                  `<div class="grid" style="grid-template-columns:1fr auto"><div>ãƒ»${
                    o.label
                  }</div><div class="price">${fmt(o.price)}</div></div>`
              )
              .join("")
          : `<div class="muted">ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ•´å‚™ãªã—</div>`;

        el("#shopBreakdown").innerHTML = `
          <div class="grid" style="grid-template-columns:1fr auto">
            <div>åŸºæœ¬ç‚¹æ¤œæ•´å‚™æ–™</div><div class="price">${fmt(
              +el("#baseFee").value || 0
            )}</div>
            <div>å‰²å¼•</div><div class="price">- ${fmt(
              +el("#discount").value || 0
            )}</div>
          </div>
          <div class="line"></div>
          ${optsHtml}`;

        el("#grandTotal").textContent = fmt(d.grand);

        const classLabel = {
          kei: "è»½",
          small: "å°å‹(ã€œ1.0t)",
          mid: "ä¸­å‹(1.0ã€œ1.5t)",
          large: "å¤§å‹(1.5ã€œ2.0t)",
          xl: "ç‰¹å¤§(2.0ã€œ2.5t)",
        }[el("#carClass").value];
        el(
          "#note"
        ).innerHTML = `<span class="muted">åŒºåˆ†:</span> ${classLabel}ã€€<span class="muted">å¹´å¼å¸¯:</span> ${
          el("#ageYears").value
        }`;

        const summary = `ã€è»Šæ¤œ æ¦‚ç®—è¦‹ç©ï¼ˆç›®å®‰ï¼‰ã€‘
è»Šä¸¡åŒºåˆ†ï¼š${classLabel}
å¹´å¼å¸¯ã€€ï¼š${el("#ageYears").value}

ï¼œæ³•å®šè²»ç”¨ æ¦‚ç®—ï¼
ãƒ»è‡ªè³ è²¬ï¼ˆ24ã‹æœˆï¼‰ï¼š${fmt(d.jb)}
ãƒ»é‡é‡ç¨ï¼ˆæ¦‚ç®—ï¼‰ã€€ï¼š${fmt(d.wt)}
ãƒ»å°ç´™ä»£ï¼ˆæ¦‚ç®—ï¼‰ã€€ï¼š${fmt(d.sp)}

ï¼œåº—èˆ—è²»ç”¨ï¼
ãƒ»åŸºæœ¬ç‚¹æ¤œæ•´å‚™æ–™ã€€ï¼š${fmt(+el("#baseFee").value || 0)}
ãƒ»å‰²å¼•ã€€ã€€ã€€ã€€ã€€ã€€ï¼š- ${fmt(+el("#discount").value || 0)}
${d.options.length ? "ãƒ»ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼š" : ""}${d.options
          .map((o) => `\n  - ${o.label}ï¼š${fmt(o.price)}`)
          .join("")}

â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•
åˆè¨ˆï¼š${fmt(d.grand)}
â€»å®Ÿè»Šç¢ºèªãƒ»æ³•æ”¹å®šã«ã‚ˆã‚Šå¢—æ¸›ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚`;
        el("#summaryText").textContent = summary;
      }

      /* ========================= LIFFåˆæœŸåŒ–ãƒ»ã‚¯ãƒ­ãƒ¼ã‚º ========================= */
      let liffReady = false;
      async function initLiff() {
        if (!window.LIFF_ID) {
          console.error("LIFF_ID ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
          return;
        }
        try {
          await liff.init({ liffId: window.LIFF_ID });
          liffReady = true;
        } catch (e) {
          console.error("LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", e);
        }
      }
      async function closeApp() {
        try {
          if (!liffReady) await initLiff();
          if (window.liff && liff.isInClient()) {
            liff.closeWindow();
          } else {
            toast(
              "å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã®ãŸã‚é–‰ã˜ã‚‰ã‚Œã¾ã›ã‚“ã€‚å·¦ä¸Šã®æˆ»ã‚‹ã§ãŠæˆ»ã‚Šãã ã•ã„ã€‚",
              false
            );
          }
        } catch (_) {
          toast("ã‚¢ãƒ—ãƒªã‚’é–‰ã˜ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚", false);
        }
      }

      /* ========================= ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ² ========================= */
      // æº€æœŸæ—¥ï¼šãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
      document
        .querySelectorAll('input[name="expMode"]')
        .forEach((r) => r.addEventListener("change", updateExpiryModeUI));
      // è¨ˆç®—ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      el("#btnPreviewExpiry").addEventListener("click", (e) => {
        e.preventDefault();
        previewExpiry();
      });
      // æº€æœŸæ—¥ç™»éŒ²ï¼ˆé€ä¿¡ã®ã¿ï¼è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºã—ãªã„ï¼‰
      el("#registerExpiryBtn").addEventListener("click", async (e) => {
        e.preventDefault();
        await registerExpiryDate();
      });
      // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ï¼ˆå„ã‚«ãƒ¼ãƒ‰ï¼‰
      el("#closeExpiryBtn").addEventListener("click", closeApp);
      el("#closeSimBtn").addEventListener("click", closeApp);

      // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼
      ["#carClass", "#ageYears", "#baseFee", "#discount"].forEach((sel) => {
        el(sel).addEventListener("change", calc);
        el(sel).addEventListener("input", calc);
      });
      els(".optChk").forEach((c) => c.addEventListener("change", calc));
      el("#calcBtn").addEventListener("click", calc);
      el("#resetBtn").addEventListener("click", () => {
        el("#carClass").value = "kei";
        el("#ageYears").value = "0-13";
        el("#baseFee").value = 19800;
        el("#discount").value = 0;
        els(".optChk").forEach((c) => (c.checked = false));
        calc();
      });
      el("#copyBtn").addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(
            el("#summaryText").textContent.trim()
          );
          toast("è¦‹ç©ã‚Šãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ", true);
        } catch (_) {
          toast("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ", false);
        }
      });
      el("#sendBtn").addEventListener("click", async () => {
        if (!liffReady) {
          await initLiff();
          if (!liffReady) {
            toast("LIFFåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ", false);
            return;
          }
        }
        const text = el("#summaryText").textContent.trim();
        try {
          if (!liff.isInClient()) {
            toast("ã‚¹ãƒãƒ›ã®LINEã‚¢ãƒ—ãƒªã‹ã‚‰é–‹ã„ã¦ãã ã•ã„", false);
            return;
          }
          const fs = await liff.getFriendship();
          if (!fs.friendFlag) {
            toast("å…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‹ã ã¡è¿½åŠ ã—ã¦ãã ã•ã„", false);
            return;
          }
          await liff.sendMessages([{ type: "text", text }]);
          toast("LINEã«é€ä¿¡ã—ã¾ã—ãŸ", true);
          // â˜…ã“ã“ã§ã‚‚è‡ªå‹•ã§é–‰ã˜ã¾ã›ã‚“ï¼ˆå¿…è¦ãªã‚‰ã€Œã‚¢ãƒ—ãƒªã‚’é–‰ã˜ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼‰
        } catch (e) {
          console.error("é€ä¿¡ã‚¨ãƒ©ãƒ¼:", e);
          let msg = "é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ";
          if (e?.message?.includes("invalid receiver"))
            msg = "ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰ã¯é€ä¿¡ã§ãã¾ã›ã‚“\n1å¯¾1ãƒˆãƒ¼ã‚¯ã‹ã‚‰é–‹ã„ã¦ãã ã•ã„";
          toast(msg, false);
        }
      });

      /* ========================= åˆæœŸåŒ– ========================= */
      updateExpiryModeUI();
      calc();
      initLiff();
    </script>
  </body>
</html>
