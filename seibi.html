<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>整備履歴 マイページ</title>
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  // ★ここにあなたのLIFF IDを入れる
  window.LIFF_ID = "2008228464-Jy1OL86j";
  // ★ここにGoogle Apps ScriptのURLを入れる
  window.GAS_URL = "https://script.google.com/macros/s/AKfycbz0EzPRsZ77DFPU8qC555lxya1Zo_KHVRbl_Z32WBKRCIKPb5GCDTgNm7mrhcEUUlDH/exec";
</script>
<style>
  :root {
    --primary: #4f46e5;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --gray: #64748b;
    --light: #f8fafc;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 16px;
  }
  .container {
    max-width: 600px;
    margin: 0 auto;
  }
  .card {
    background: white;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
  }
  .avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    font-weight: bold;
  }
  .user-info h2 {
    font-size: 20px;
    color: #1e293b;
    margin-bottom: 4px;
  }
  .user-info p {
    font-size: 14px;
    color: var(--gray);
  }
  .section-title {
    font-size: 16px;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
  }
  .badge-warning {
    background: #fef3c7;
    color: #92400e;
  }
  .badge-danger {
    background: #fee2e2;
    color: #991b1b;
  }
  .badge-success {
    background: #d1fae5;
    color: #065f46;
  }
  .recommendation {
    background: var(--light);
    border-left: 4px solid var(--warning);
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 8px;
  }
  .recommendation.urgent {
    border-left-color: var(--danger);
    background: #fef2f2;
  }
  .recommendation h4 {
    font-size: 14px;
    color: #1e293b;
    margin-bottom: 4px;
  }
  .recommendation p {
    font-size: 13px;
    color: var(--gray);
  }
  .history-item {
    border-bottom: 1px solid #e5e7eb;
    padding: 16px 0;
  }
  .history-item:last-child {
    border-bottom: none;
  }
  .history-date {
    font-size: 13px;
    color: var(--gray);
    margin-bottom: 4px;
  }
  .history-type {
    font-size: 16px;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 4px;
  }
  .history-detail {
    font-size: 14px;
    color: var(--gray);
    margin-bottom: 8px;
  }
  .history-meta {
    display: flex;
    justify-content: space-between;
    font-size: 13px;
  }
  .price {
    font-weight: 600;
    color: var(--primary);
  }
  .mileage {
    color: var(--gray);
  }
  .loading {
    text-align: center;
    padding: 40px 20px;
    color: white;
  }
  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  .error {
    background: #fee2e2;
    color: #991b1b;
    padding: 16px;
    border-radius: 12px;
    text-align: center;
  }
  .empty {
    text-align: center;
    padding: 40px 20px;
    color: var(--gray);
  }
  .btn {
    display: block;
    width: 100%;
    padding: 14px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 12px;
  }
</style>
</head>
<body>

<div id="loading" class="loading">
  <div class="loading-spinner"></div>
  <p>読み込み中...</p>
</div>

<div id="content" class="container" style="display:none;">
  <!-- ヘッダー -->
  <div class="card">
    <div class="header">
      <div class="avatar" id="avatar">👤</div>
      <div class="user-info">
        <h2 id="userName">-</h2>
        <p id="carInfo">-</p>
      </div>
    </div>
  </div>

  <!-- 次回メンテナンス推奨 -->
  <div class="card">
    <div class="section-title">
      🔧 次回メンテナンス推奨
    </div>
    <div id="recommendations"></div>
  </div>

  <!-- 整備履歴 -->
  <div class="card">
    <div class="section-title">
      📋 整備履歴
    </div>
    <div id="historyList"></div>
  </div>

  <!-- 予約ボタン -->
  <button class="btn" onclick="openReservation()">
    📅 次回メンテナンスを予約する
  </button>
</div>

<div id="error" class="container" style="display:none;">
  <div class="card error">
    <h3 style="margin-bottom:8px;">⚠️ エラー</h3>
    <p id="errorMessage">データの取得に失敗しました</p>
  </div>
</div>

<script>
let userId = '';

// ========================================
// LIFF初期化
// ========================================
async function initApp() {
  try {
    await liff.init({ liffId: window.LIFF_ID });
    
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    
    const profile = await liff.getProfile();
    userId = profile.userId;
    
    // アバターのイニシャル
    document.getElementById('avatar').textContent = 
      profile.displayName.charAt(0);
    
    // データ取得
    await loadData();
    
  } catch (error) {
    console.error('LIFF初期化エラー:', error);
    showError('LINEとの接続に失敗しました');
  }
}

// ========================================
// データ読み込み
// ========================================
async function loadData() {
  try {
    const response = await fetch(`${window.GAS_URL}?userId=${userId}`);
    const result = await response.json();
    
    if (result.status === 'error') {
      throw new Error(result.message);
    }
    
    const data = result.data;
    
    // 顧客情報表示
    document.getElementById('userName').textContent = data.customer.name;
    document.getElementById('carInfo').textContent = 
      `${data.customer.carModel} (${data.customer.carNumber})`;
    
    // 次回メンテナンス表示
    displayRecommendations(data.nextMaintenance);
    
    // 整備履歴表示
    displayHistory(data.history);
    
    // 画面切り替え
    document.getElementById('loading').style.display = 'none';
    document.getElementById('content').style.display = 'block';
    
  } catch (error) {
    console.error('データ取得エラー:', error);
    showError(error.message || 'データの取得に失敗しました');
  }
}

// ========================================
// 次回メンテナンス推奨を表示
// ========================================
function displayRecommendations(recommendations) {
  const container = document.getElementById('recommendations');
  
  if (!recommendations || recommendations.length === 0) {
    container.innerHTML = '<p class="empty">現在、推奨メンテナンスはありません✨</p>';
    return;
  }
  
  container.innerHTML = recommendations.map(rec => {
    const isUrgent = rec.urgency === '至急';
    const badge = isUrgent 
      ? '<span class="badge badge-danger">至急</span>'
      : '<span class="badge badge-warning">推奨</span>';
    
    return `
      <div class="recommendation ${isUrgent ? 'urgent' : ''}">
        <h4>${rec.type} ${badge}</h4>
        <p>${rec.reason}</p>
      </div>
    `;
  }).join('');
}

// ========================================
// 整備履歴を表示
// ========================================
function displayHistory(history) {
  const container = document.getElementById('historyList');
  
  if (!history || history.length === 0) {
    container.innerHTML = '<p class="empty">整備履歴がありません</p>';
    return;
  }
  
  container.innerHTML = history.map(item => `
    <div class="history-item">
      <div class="history-date">${formatDate(item.date)}</div>
      <div class="history-type">${item.type}</div>
      <div class="history-detail">${item.detail}</div>
      <div class="history-meta">
        <span class="price">¥${item.price.toLocaleString()}</span>
        <span class="mileage">${item.mileage ? item.mileage.toLocaleString() + 'km' : '-'}</span>
      </div>
    </div>
  `).join('');
}

// ========================================
// 日付フォーマット
// ========================================
function formatDate(dateStr) {
  const date = new Date(dateStr);
  const year = date.getFullYear();
  const month = date.getMonth() + 1;
  const day = date.getDate();
  return `${year}年${month}月${day}日`;
}

// ========================================
// エラー表示
// ========================================
function showError(message) {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('content').style.display = 'none';
  document.getElementById('error').style.display = 'block';
  document.getElementById('errorMessage').textContent = message;
}

// ========================================
// 予約ボタン
// ========================================
function openReservation() {
  // エルメッセージの予約ページやリッチメニューを開く
  liff.openWindow({
    url: 'https://lin.ee/あなたの予約ページ',
    external: false
  });
}

// ========================================
// 初期化実行
// ========================================
window.addEventListener('DOMContentLoaded', initApp);
</script>

</body>
</html>