<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Êï¥ÂÇôÂ±•Ê≠¥ „Éû„Ç§„Éö„Éº„Ç∏</title>

    <script
      src="https://static.line-scdn.net/liff/edge/2/sdk.js"
      charset="utf-8"
    ></script>
    <script>
      window.LIFF_ID = "2008228464-Jy1OL86j";
      window.GAS_URL =
        "https://script.google.com/macros/s/AKfycbz0EzPRsZ77DFPU8qC555lxya1Zo_KHVRbl_Z32WBKRCIKPb5GCDTgNm7mrhcEUUlDH/exec";
      window.POST_TOKEN = "change-me-32chars";
      window.BOOKING =
        "https://liff.line.me/2008228464-nMpDkLPK?calendar_salon_id=18905&ts=1760362889";
    </script>

    <style>
      :root {
        --primary: #4f46e5;
        --warning: #f59e0b;
        --danger: #ef4444;
        --gray: #64748b;
        --border: #e5e7eb;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          "Noto Sans JP", sans-serif;
        background: linear-gradient(135deg, #667eea, #764ba2);
        min-height: 100vh;
        padding: 16px;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
      }
      .card {
        background: #fff;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .header {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 20px;
      }
      .avatar {
        width: 60px;
        height: 60px;
        aspect-ratio: 1/1;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 24px;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea, #764ba2);
      }
      .section-title {
        font-size: 16px;
        font-weight: 700;
        color: #111;
        margin-bottom: 12px;
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        padding: 14px;
        background: var(--primary);
        color: #fff;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
      }
      .btn.ghost {
        background: #e5e7eb;
        color: #111;
      }
      .loading {
        text-align: center;
        padding: 40px 20px;
        color: #fff;
      }
      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .empty {
        text-align: center;
        padding: 40px 20px;
        color: var(--gray);
      }
      .modal {
        position: fixed;
        inset: 0;
        display: none;
        place-items: center;
        padding: 16px;
        z-index: 9999;
      }
      .modal.show {
        display: grid;
      }
      .modal-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
      }
      .modal-card {
        position: relative;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
        width: min(720px, 92vw);
        max-width: 720px;
        display: flex;
        flex-direction: column;
        max-height: 88vh;
        bottom: 12px;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 18px;
        border-bottom: 1px solid var(--border);
      }
      .modal-body {
        overflow: auto;
        padding: 8px 2px;
        max-height: 60vh;
      }
      .modal-footer {
        display: flex;
        gap: 10px;
        padding: 12px;
        border-top: 1px solid var(--border);
        background: #fff;
        border-radius: 0 0 16px 16px;
      }
      .vehicle {
        padding: 12px 18px;
        border-bottom: 1px dashed var(--border);
        display: grid;
        gap: 6px;
      }
      .v-title {
        font-weight: 800;
        color: #111;
      }
      .v-sub {
        color: #6b7280;
        font-size: 14px;
        line-height: 1.6;
      }
      .v-main {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 6px;
      }
      .hist {
        padding: 16px 18px;
        border-bottom: 1px solid var(--border);
      }
      .hist-date {
        color: #64748b;
        font-size: 14px;
        margin-bottom: 4px;
      }
      .hist-type {
        font-size: 18px;
        font-weight: 800;
        margin-bottom: 4px;
      }
      .hist-detail {
        font-size: 14px;
        color: #6b7280;
        margin-bottom: 6px;
        white-space: pre-wrap;
      }
      .hist-meta {
        display: flex;
        justify-content: space-between;
      }
    </style>
  </head>
  <body>
    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <p>Ë™≠„ÅøËæº„Åø‰∏≠...</p>
    </div>

    <div id="content" class="container" style="display: none">
      <div class="card">
        <div class="header">
          <div class="avatar" id="avatar">üë§</div>
          <div class="user-info">
            <h2 id="userName">-</h2>
            <p id="carInfo">-</p>
          </div>
        </div>
        <button class="btn ghost" id="openCarBtn">Ëªä‰∏°ÊÉÖÂ†±„ÇíË¶ã„Çã</button>
      </div>

      <div class="card">
        <div class="section-title">üîß Ê¨°Âõû„É°„É≥„ÉÜ„Éä„É≥„ÇπÊé®Â•®</div>
        <div id="recommendations"></div>
      </div>

      <div class="card">
        <div class="section-title">üìã Êï¥ÂÇôÂ±•Ê≠¥</div>
        <button class="btn" id="openHistoryBtn">Êï¥ÂÇôÂ±•Ê≠¥„ÇíË¶ã„Çã</button>
      </div>

      <div class="card">
        <div class="section-title">üìè Ëµ∞Ë°åË∑ùÈõ¢„ÅÆÊõ¥Êñ∞</div>
        <div style="display: flex; gap: 8px">
          <input
            id="mileageInput"
            type="number"
            inputmode="numeric"
            placeholder="ÁèæÂú®„ÅÆËµ∞Ë°åË∑ùÈõ¢ (km)"
            style="
              flex: 1;
              padding: 12px;
              border: 1px solid var(--border);
              border-radius: 10px;
            "
          />
          <button class="btn" id="saveMileageBtn" style="width: auto">
            ‰øùÂ≠ò
          </button>
        </div>
        <p
          class="badge"
          style="margin-top: 8px; background: #eef2ff; color: #3730a3"
        >
          ÊúÄÊñ∞„ÅÆË∑ùÈõ¢„ÇíÂÖ•„Çå„Çã„Å®Êé®Â•®„Çø„Ç§„Éü„É≥„Ç∞„ÅåË≥¢„Åè„Å™„Çä„Åæ„Åô
        </p>
      </div>

      <button class="btn" id="reserveBtn">üìÖ Ê¨°Âõû„É°„É≥„ÉÜ„Éä„É≥„Çπ„Çí‰∫àÁ¥Ñ„Åô„Çã</button>
    </div>

    <!-- Â±•Ê≠¥„É¢„Éº„ÉÄ„É´ -->
    <div id="historyModal" class="modal" aria-hidden="true">
      <div class="modal-backdrop"></div>
      <div class="modal-card">
        <div class="modal-header">
          <div class="modal-title">üìÑ Êï¥ÂÇôÂ±•Ê≠¥</div>
          <button class="btn ghost" id="closeHistoryBtn" style="width: auto">
            Èñâ„Åò„Çã
          </button>
        </div>
        <div class="modal-body"><div id="modalHistoryList"></div></div>
        <div class="modal-footer" id="modalFooter" style="display: none"></div>
      </div>
    </div>

    <!-- Ëªä‰∏°„É¢„Éº„ÉÄ„É´ -->
    <div id="carModal" class="modal" aria-hidden="true">
      <div class="modal-backdrop"></div>
      <div class="modal-card">
        <div class="modal-header">
          <div class="modal-title">üöó Ëªä‰∏°ÊÉÖÂ†±</div>
          <button class="btn ghost" id="closeCarBtn" style="width: auto">
            Èñâ„Åò„Çã
          </button>
        </div>
        <div class="modal-body"><div id="vehicleList"></div></div>
      </div>
    </div>

    <!-- ËªäÊ§ú„Ç¢„É©„Éº„ÉàÔºàËªΩÈáè„Éù„ÉÉ„ÉóÔºâ -->
    <div
      id="inspToast"
      style="
        display: none;
        position: fixed;
        left: 50%;
        bottom: 24px;
        transform: translateX(-50%);
        background: #111;
        color: #fff;
        padding: 12px 16px;
        border-radius: 12px;
        font-weight: 700;
        z-index: 99999;
      "
    ></div>

    <script>
      /* ===== helpers ===== */
      const $ = (s, el = document) => el.querySelector(s);
      const $$ = (s, el = document) => Array.from(el.querySelectorAll(s));
      const toast = (m, ms = 2000) => {
        const n = document.createElement("div");
        n.textContent = m;
        n.style.cssText =
          "position:fixed;left:50%;top:16px;transform:translateX(-50%);background:rgba(16,185,129,.95);color:#fff;padding:10px 14px;border-radius:999px;font-weight:700;z-index:9999";
        document.body.appendChild(n);
        setTimeout(() => n.remove(), ms);
      };
      const fmtDate = (s) => {
        const d = new Date(s);
        return isNaN(+d)
          ? "-"
          : `${d.getFullYear()}Âπ¥${d.getMonth() + 1}Êúà${d.getDate()}Êó•`;
      };

      async function getJSON(url) {
        const r = await fetch(url, { credentials: "omit" });
        if (!r.ok) throw new Error("fetch failed");
        return r.json();
      }
      async function postGAS(obj) {
        const fd = new FormData();
        for (const [k, v] of Object.entries(obj))
          fd.append(
            k,
            typeof v === "object" ? JSON.stringify(v) : String(v ?? "")
          );
        const r = await fetch(window.GAS_URL, {
          method: "POST",
          body: fd,
          credentials: "omit",
        });
        return r.json();
      }

      /* ===== state ===== */
      let userId = "";
      let DATA = {
        customer: null,
        history: [],
        vehicles: [],
        nextMaintenance: [],
      };

      window.addEventListener("DOMContentLoaded", initApp);

      async function initApp() {
        try {
          await liff.init({ liffId: window.LIFF_ID });
          if (!liff.isLoggedIn()) {
            liff.login();
            return;
          }
          const profile = await liff.getProfile();
          userId = profile.userId;
          $("#avatar").textContent = (profile.displayName || "üë§").charAt(0);
          await loadAll();
          $("#loading").style.display = "none";
          $("#content").style.display = "block";
        } catch (e) {
          console.error(e);
          alert("LINE„Å®„ÅÆÊé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
        }
      }

      async function loadAll() {
        const j = await getJSON(
          `${window.GAS_URL}?userId=${encodeURIComponent(userId)}`
        );
        if (j.status !== "success") throw new Error(j.message || "error");
        DATA = j.data || {};
        renderHeader();
        renderRecs();
        setupHistoryModal();
        setupVehiclesModal();
        maybePopupInspection();
      }

      function renderHeader() {
        const customer = DATA.customer || {};
        const vehicles = Array.isArray(DATA.vehicles) ? DATA.vehicles : [];
        const primary =
          vehicles.find((v) => v.isPrimary) || vehicles[0] || null;
        const model = primary?.modelName || customer.carModel || "-";
        const plate = customer.carNumber || "-";
        $("#userName").textContent = customer.name || "-";
        $("#carInfo").textContent = `${model} (${plate})`;
      }

      function renderRecs() {
        const box = $("#recommendations");
        const recs = Array.isArray(DATA.nextMaintenance)
          ? DATA.nextMaintenance
          : [];
        if (!recs.length) {
          box.innerHTML =
            '<p class="empty">ÁèæÂú®„ÄÅÊé®Â•®„É°„É≥„ÉÜ„Éä„É≥„Çπ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì‚ú®</p>';
          return;
        }
        box.innerHTML = recs
          .map((r) => {
            const urgent = r.urgency === "Ëá≥ÊÄ•";
            const badge = urgent
              ? '<span class="badge" style="background:#fee2e2;color:#991b1b">Ëá≥ÊÄ•</span>'
              : '<span class="badge" style="background:#fef3c7;color:#92400e">Êé®Â•®</span>';
            return `<div class="card" style="padding:12px;margin:0 0 8px 0">
                  <div style="display:flex;align-items:center;gap:8px"><strong>${
                    r.type
                  }</strong> ${badge}</div>
                  <p>${r.reason || ""}</p>
                </div>`;
          })
          .join("");
      }

      /* ===== history modal ===== */
      $("#openHistoryBtn").addEventListener("click", () => {
        const list = Array.isArray(DATA.history) ? DATA.history : [];
        $("#modalHistoryList").innerHTML = list.length
          ? list
              .map(
                (item) => `
        <div class="hist">
          <div class="hist-date">${fmtDate(item.date)}</div>
          <div class="hist-type">${item.type || ""}</div>
          <div class="hist-detail">${item.detail || ""}</div>
          <div class="hist-meta">
            <span>¬•${(Number(item.price) || 0).toLocaleString()}</span>
            <span>${
              item.mileage ? Number(item.mileage).toLocaleString() + "km" : "-"
            }</span>
          </div>
        </div>
      `
              )
              .join("")
          : '<div class="empty">Â±•Ê≠¥„Åå„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
        openHistory();
      });
      $("#closeHistoryBtn").addEventListener("click", closeHistory);
      $("#historyModal .modal-backdrop").addEventListener(
        "click",
        closeHistory
      );
      function openHistory() {
        $("#historyModal").classList.add("show");
        $("#historyModal").setAttribute("aria-hidden", "false");
      }
      function closeHistory() {
        $("#historyModal").classList.remove("show");
        $("#historyModal").setAttribute("aria-hidden", "true");
      }
      function setupHistoryModal() {
        /* „Éö„Éº„Ç∏„É£ÁúÅÁï•Ôºà‰ª∂Êï∞Â∞ëÊÉ≥ÂÆöÔºâ */
      }

      /* ===== vehicles modal ===== */
      $("#openCarBtn").addEventListener("click", () => {
        renderVehicleList();
        openCar();
      });
      $("#closeCarBtn").addEventListener("click", closeCar);
      $("#carModal .modal-backdrop").addEventListener("click", closeCar);
      function openCar() {
        $("#carModal").classList.add("show");
        $("#carModal").setAttribute("aria-hidden", "false");
      }
      function closeCar() {
        $("#carModal").classList.remove("show");
        $("#carModal").setAttribute("aria-hidden", "true");
      }

      function renderVehicleList() {
        const el = $("#vehicleList");
        const vehicles = Array.isArray(DATA.vehicles) ? DATA.vehicles : [];
        if (!vehicles.length) {
          el.innerHTML =
            '<div class="vehicle"><div class="v-title">Ëªä‰∏°ÊÉÖÂ†±„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div></div>';
          return;
        }
        el.innerHTML = vehicles
          .map(
            (v, i) => `
        <div class="vehicle">
          <div class="v-title">${i + 1}. ${v.modelName || "-"}</div>
          <div class="v-sub">„Ç´„ÉÜ„Ç¥„É™Ôºö${v.category || "-"}</div>
          <div class="v-sub">ÊéíÊ∞óÈáèÔºö${v.displacement || "-"}</div>
          <div class="v-sub">ÂàùÂπ¥Â∫¶ÁôªÈå≤Ôºö${
            v.firstReg ? fmtDate(v.firstReg) : "-"
          }</div>
          <div class="v-sub">Ê¨°ÂõûËªäÊ§úÔºö${
            v.nextInspection ? fmtDate(v.nextInspection) : "-"
          }</div>
          <div class="v-sub">ÊÆã„ÇäÊó•Êï∞Ôºö${
            typeof v.daysToInspection === "number"
              ? v.daysToInspection + "Êó•"
              : "-"
          }</div>
          <label class="v-main">
            <input type="radio" name="primaryVehicle" value="${v.row}" ${
              v.isPrimary ? "checked" : ""
            } />
            „Åì„ÅÆËªä„Çí„É°„Ç§„É≥Ë°®Á§∫„Å´„Åô„Çã
          </label>
        </div>
      `
          )
          .join("");

        $("#vehicleList")
          .querySelectorAll('input[name="primaryVehicle"]')
          .forEach((r) => {
            r.addEventListener("change", async (e) => {
              const row = Number(e.target.value);
              try {
                const j = await postGAS({
                  action: "setPrimaryVehicle",
                  userId,
                  row,
                  token: window.POST_TOKEN,
                });
                if (j.status === "success") {
                  toast("„É°„Ç§„É≥Ëªä‰∏°„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü");
                  // ÁîªÈù¢ÂÅ¥„ÅÆ„Éï„É©„Ç∞Êõ¥Êñ∞
                  DATA.vehicles = DATA.vehicles.map((v) => ({
                    ...v,
                    isPrimary: v.row === row,
                  }));
                  renderHeader();
                } else {
                  toast("Êõ¥Êñ∞„Å´Â§±Êïó: " + (j.message || ""));
                }
              } catch (ex) {
                console.error(ex);
                toast("ÈÄö‰ø°„Ç®„É©„Éº");
              }
            });
          });
      }
      function setupVehiclesModal() {
        /* ÂàùÂõû„É¨„É≥„ÉÄ„É™„É≥„Ç∞„ÅØopenÊôÇ */
      }

      /* ===== save mileage ===== */
      $("#saveMileageBtn").addEventListener("click", async () => {
        const v = Number($("#mileageInput").value || 0);
        if (!v) {
          toast("Ëµ∞Ë°åË∑ùÈõ¢„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
          return;
        }
        const j = await postGAS({
          action: "updateMileage",
          userId,
          mileage: v,
          token: window.POST_TOKEN,
        });
        if (j.status === "success") {
          toast("‰øùÂ≠ò„Åó„Åæ„Åó„Åü");
          await loadAll();
        } else {
          toast("‰øùÂ≠ò„Å´Â§±Êïó: " + (j.message || ""));
        }
      });

      /* ===== booking ===== */
      $("#reserveBtn").addEventListener("click", () => {
        const veh =
          (Array.isArray(DATA.vehicles) ? DATA.vehicles : []).find(
            (v) => v.isPrimary
          ) || null;
        const url = new URL(window.BOOKING);
        if (veh) {
          url.searchParams.set("vehicle_row", veh.row);
          url.searchParams.set("model", veh.modelName || "");
        }
        liff.openWindow({ url: url.toString(), external: false });
      });

      /* ===== ËªäÊ§úÊúüÊó•„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó ===== */
      function maybePopupInspection() {
        const veh =
          (Array.isArray(DATA.vehicles) ? DATA.vehicles : []).find(
            (v) => v.isPrimary
          ) || null;
        if (!veh || typeof veh.daysToInspection !== "number") return;
        const rest = veh.daysToInspection;
        const thresholds = [90, 60, 30, 7];
        const key = `insp_snooze_${veh.row}`;
        const until = localStorage.getItem(key);
        if (until && Date.now() < Number(until)) return;

        if (rest >= 0 && thresholds.some((d) => rest <= d)) {
          const el = $("#inspToast");
          el.textContent = `Ê¨°ÂõûËªäÊ§ú„ÅØ ${fmtDate(
            veh.nextInspection
          )}ÔºàÊÆã„Çä ${rest} Êó•Ôºâ`;
          el.style.display = "block";
          setTimeout(() => {
            el.style.display = "none";
          }, 5000);
          // 1Êó•„Çπ„Éå„Éº„Ç∫
          localStorage.setItem(key, String(Date.now() + 24 * 60 * 60 * 1000));
        }
      }
    </script>
  </body>
</html>
