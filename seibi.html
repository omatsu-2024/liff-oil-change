<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>æ•´å‚™å±¥æ­´ ãƒã‚¤ãƒšãƒ¼ã‚¸</title>
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  // â˜…ã“ã“ã«ã‚ãªãŸã®LIFF IDã‚’å…¥ã‚Œã‚‹
  window.LIFF_ID = "2008228464-Jy1OL86j";
  // â˜…ã“ã“ã«Google Apps Scriptã®URLã‚’å…¥ã‚Œã‚‹
  window.GAS_URL = "https://script.google.com/macros/s/AKfycbz0EzPRsZ77DFPU8qC555lxya1Zo_KHVRbl_Z32WBKRCIKPb5GCDTgNm7mrhcEUUlDH/exec";
</script>
<style>
  :root {
    --primary: #4f46e5;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --gray: #64748b;
    --light: #f8fafc;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 16px;
  }
  .container {
    max-width: 600px;
    margin: 0 auto;
  }
  .card {
    background: white;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
  }
  .avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    font-weight: bold;
  }
  .user-info h2 {
    font-size: 20px;
    color: #1e293b;
    margin-bottom: 4px;
  }
  .user-info p {
    font-size: 14px;
    color: var(--gray);
  }
  .section-title {
    font-size: 16px;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
  }
  .badge-warning {
    background: #fef3c7;
    color: #92400e;
  }
  .badge-danger {
    background: #fee2e2;
    color: #991b1b;
  }
  .badge-success {
    background: #d1fae5;
    color: #065f46;
  }
  .recommendation {
    background: var(--light);
    border-left: 4px solid var(--warning);
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 8px;
  }
  .recommendation.urgent {
    border-left-color: var(--danger);
    background: #fef2f2;
  }
  .recommendation h4 {
    font-size: 14px;
    color: #1e293b;
    margin-bottom: 4px;
  }
  .recommendation p {
    font-size: 13px;
    color: var(--gray);
  }
  .history-item {
    border-bottom: 1px solid #e5e7eb;
    padding: 16px 0;
  }
  .history-item:last-child {
    border-bottom: none;
  }
  .history-date {
    font-size: 13px;
    color: var(--gray);
    margin-bottom: 4px;
  }
  .history-type {
    font-size: 16px;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 4px;
  }
  .history-detail {
    font-size: 14px;
    color: var(--gray);
    margin-bottom: 8px;
  }
  .history-meta {
    display: flex;
    justify-content: space-between;
    font-size: 13px;
  }
  .price {
    font-weight: 600;
    color: var(--primary);
  }
  .mileage {
    color: var(--gray);
  }
  .loading {
    text-align: center;
    padding: 40px 20px;
    color: white;
  }
  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  .error {
    background: #fee2e2;
    color: #991b1b;
    padding: 16px;
    border-radius: 12px;
    text-align: center;
  }
  .empty {
    text-align: center;
    padding: 40px 20px;
    color: var(--gray);
  }
  .btn {
    display: block;
    width: 100%;
    padding: 14px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 12px;
  }
</style>
</head>
<body>

<div id="loading" class="loading">
  <div class="loading-spinner"></div>
  <p>èª­ã¿è¾¼ã¿ä¸­...</p>
</div>

<div id="content" class="container" style="display:none;">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="card">
    <div class="header">
      <div class="avatar" id="avatar">ğŸ‘¤</div>
      <div class="user-info">
        <h2 id="userName">-</h2>
        <p id="carInfo">-</p>
      </div>
    </div>
  </div>

  <!-- æ¬¡å›ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ¨å¥¨ -->
  <div class="card">
    <div class="section-title">
      ğŸ”§ æ¬¡å›ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ¨å¥¨
    </div>
    <div id="recommendations"></div>
  </div>

  <!-- æ•´å‚™å±¥æ­´ -->
  <div class="card">
    <div class="section-title">
      ğŸ“‹ æ•´å‚™å±¥æ­´
    </div>
    <div id="historyList"></div>
  </div>

  <!-- äºˆç´„ãƒœã‚¿ãƒ³ -->
  <button class="btn" onclick="openReservation()">
    ğŸ“… æ¬¡å›ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚’äºˆç´„ã™ã‚‹
  </button>
</div>

<div id="error" class="container" style="display:none;">
  <div class="card error">
    <h3 style="margin-bottom:8px;">âš ï¸ ã‚¨ãƒ©ãƒ¼</h3>
    <p id="errorMessage">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
  </div>
</div>

<script>
let userId = '';

// ========================================
// LIFFåˆæœŸåŒ–
// ========================================
async function initApp() {
  try {
    await liff.init({ liffId: window.LIFF_ID });
    
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    
    const profile = await liff.getProfile();
    userId = profile.userId;
    
    // ã‚¢ãƒã‚¿ãƒ¼ã®ã‚¤ãƒ‹ã‚·ãƒ£ãƒ«
    document.getElementById('avatar').textContent = 
      profile.displayName.charAt(0);
    
    // ãƒ‡ãƒ¼ã‚¿å–å¾—
    await loadData();
    
  } catch (error) {
    console.error('LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
    showError('LINEã¨ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// ========================================
// ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
// ========================================
async function loadData() {
  try {
    const response = await fetch(`${window.GAS_URL}?userId=${userId}`);
    const result = await response.json();
    
    if (result.status === 'error') {
      throw new Error(result.message);
    }
    
    const data = result.data;
    
    // é¡§å®¢æƒ…å ±è¡¨ç¤º
    document.getElementById('userName').textContent = data.customer.name;
    document.getElementById('carInfo').textContent = 
      `${data.customer.carModel} (${data.customer.carNumber})`;
    
    // æ¬¡å›ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹è¡¨ç¤º
    displayRecommendations(data.nextMaintenance);
    
    // æ•´å‚™å±¥æ­´è¡¨ç¤º
    displayHistory(data.history);
    
    // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
    document.getElementById('loading').style.display = 'none';
    document.getElementById('content').style.display = 'block';
    
  } catch (error) {
    console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    showError(error.message || 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// ========================================
// æ¬¡å›ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ¨å¥¨ã‚’è¡¨ç¤º
// ========================================
function displayRecommendations(recommendations) {
  const container = document.getElementById('recommendations');
  
  if (!recommendations || recommendations.length === 0) {
    container.innerHTML = '<p class="empty">ç¾åœ¨ã€æ¨å¥¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã¯ã‚ã‚Šã¾ã›ã‚“âœ¨</p>';
    return;
  }
  
  container.innerHTML = recommendations.map(rec => {
    const isUrgent = rec.urgency === 'è‡³æ€¥';
    const badge = isUrgent 
      ? '<span class="badge badge-danger">è‡³æ€¥</span>'
      : '<span class="badge badge-warning">æ¨å¥¨</span>';
    
    return `
      <div class="recommendation ${isUrgent ? 'urgent' : ''}">
        <h4>${rec.type} ${badge}</h4>
        <p>${rec.reason}</p>
      </div>
    `;
  }).join('');
}

// ========================================
// æ•´å‚™å±¥æ­´ã‚’è¡¨ç¤º
// ========================================
function displayHistory(history) {
  const container = document.getElementById('historyList');
  
  if (!history || history.length === 0) {
    container.innerHTML = '<p class="empty">æ•´å‚™å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
    return;
  }
  
  container.innerHTML = history.map(item => `
    <div class="history-item">
      <div class="history-date">${formatDate(item.date)}</div>
      <div class="history-type">${item.type}</div>
      <div class="history-detail">${item.detail}</div>
      <div class="history-meta">
        <span class="price">Â¥${item.price.toLocaleString()}</span>
        <span class="mileage">${item.mileage ? item.mileage.toLocaleString() + 'km' : '-'}</span>
      </div>
    </div>
  `).join('');
}

// ========================================
// æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
// ========================================
function formatDate(dateStr) {
  const date = new Date(dateStr);
  const year = date.getFullYear();
  const month = date.getMonth() + 1;
  const day = date.getDate();
  return `${year}å¹´${month}æœˆ${day}æ—¥`;
}

// ========================================
// ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
// ========================================
function showError(message) {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('content').style.display = 'none';
  document.getElementById('error').style.display = 'block';
  document.getElementById('errorMessage').textContent = message;
}

// ========================================
// äºˆç´„ãƒœã‚¿ãƒ³
// ========================================
function openReservation() {
  // ã‚¨ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®äºˆç´„ãƒšãƒ¼ã‚¸ã‚„ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã
  liff.openWindow({
    url: 'https://lin.ee/ã‚ãªãŸã®äºˆç´„ãƒšãƒ¼ã‚¸',
    external: false
  });
}

// ========================================
// åˆæœŸåŒ–å®Ÿè¡Œ
// ========================================
window.addEventListener('DOMContentLoaded', initApp);
</script>

</body>
</html>