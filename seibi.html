<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>整備履歴 マイページ</title>

    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
      // ==== 必要に応じて書き換え ====
      window.LIFF_ID   = "2008228464-Jy1OL86j";
      window.GAS_URL   = "https://script.google.com/macros/s/AKfycbz0EzPRsZ77DFPU8qC555lxya1Zo_KHVRbl_Z32WBKRCIKPb5GCDTgNm7mrhcEUUlDH/exec";
      window.POST_TOKEN = "change-me-32chars";
      window.BOOKING_BASE = "https://liff.line.me/2008228464-nMpDkLPK?calendar_salon_id=18905&ts=1760362889";
    </script>

    <style>
      :root { --primary:#16a34a; --warning:#f59e0b; --danger:#ef4444; --gray:#64748b; --light:#f8fafc; --border:#e5e7eb; }
      *{box-sizing:border-box;margin:0;padding:0}
      body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans JP",sans-serif;background:linear-gradient(135deg,#34d399 0%,#16a34a 100%);min-height:100vh;padding:16px;}
      .container{max-width:600px;margin:0 auto;}
      .card{background:#fff;border-radius:16px;padding:20px;margin-bottom:16px;box-shadow:0 4px 12px rgba(0,0,0,.1);}
      .header{display:flex;align-items:center;gap:12px;margin-bottom:20px;}
      .avatar{flex:0 0 60px;width:60px;height:60px;aspect-ratio:1/1;border-radius:50%;background:linear-gradient(135deg,#34d399,#16a34a);display:inline-flex;align-items:center;justify-content:center;color:#fff;font-size:24px;font-weight:700;}
      .user-info h2{font-size:20px;color:#1e293b;margin-bottom:4px;}
      .user-info p{font-size:14px;color:var(--gray);}
      .section-title{font-size:16px;font-weight:700;color:#1e293b;margin-bottom:12px;display:flex;gap:8px;align-items:center;}
      .badge{display:inline-block;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:600;}
      .recommendation{background:var(--light);border-left:4px solid var(--warning);padding:12px;border-radius:8px;margin-bottom:8px;}
      .recommendation.urgent{border-left-color:var(--danger);background:#fef2f2;}
      .loading{text-align:center;padding:40px 20px;color:#fff;}
      .loading-spinner{width:40px;height:40px;border:4px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px;}
      @keyframes spin{to{transform:rotate(360deg)}}
      .error{background:#fee2e2;color:#991b1b;padding:16px;border-radius:12px;text-align:center;}
      .empty{text-align:center;padding:40px 20px;color:var(--gray);}
      .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:14px;background:var(--primary);color:#fff;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;}
      .btn.ghost{background:#e5e7eb;color:#111;}
      .btn:disabled{opacity:.6;cursor:default;}
      input,select,button{font-size:16px;}
      .row{display:flex;gap:8px;}
      .date-field{display:flex;align-items:center;border:1px solid var(--border);border-radius:10px;padding:8px 12px;background:#fff;}
      .date-icon{flex:0 0 auto;margin-right:8px;width:24px;height:24px;border:2px solid var(--primary);border-radius:6px;display:grid;place-items:center;color:var(--primary);font-weight:900;cursor:pointer;}
      .date-input{flex:1;border:none;outline:none;font-size:16px;min-height:28px;background:transparent;}
      .date-hint{font-size:12px;color:#6b7280;margin-top:6px;}
      .modal{position:fixed;inset:0;display:none;place-items:center;padding:16px;z-index:9999;}
      .modal.show{display:grid;}
      .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.45);}
      .modal-card{position:relative;background:#fff;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.25);width:min(720px,92vw);max-width:720px;display:flex;flex-direction:column;max-height:88vh;bottom:12px;}
      .modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--border);}
      .modal-title{font-size:18px;font-weight:800;display:flex;align-items:center;gap:8px;}
      .modal-close{background:#ecfdf5;color:#065f46;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer;}
      .modal-body{overflow:auto;padding:8px 2px;max-height:60vh;}
      .modal-footer{display:flex;gap:10px;padding:12px;border-top:1px solid var(--border);background:#fff;border-radius:0 0 16px 16px;}
      .modal-card.shrink{bottom:auto;}
      .modal-card.shrink .modal-body{max-height:48vh;}
      .hist{padding:16px 18px;border-bottom:1px solid var(--border);}
      .hist-date{color:#64748b;font-size:14px;margin-bottom:4px;}
      .hist-type{font-size:18px;font-weight:800;color:#111;margin-bottom:4px;}
      .hist-detail{font-size:14px;color:#6b7280;margin-bottom:6px;}
      .hist-meta{display:flex;justify-content:space-between;color:#111;}
      .hist-meta .price{color:var(--primary);font-weight:800;}
      .hist-meta .km{color:#6b7280;}
      .vehicle{padding:12px 18px;border-bottom:1px dashed var(--border);display:grid;gap:6px;}
      .vehicle:last-child{border-bottom:none;}
      .v-title{font-weight:800;color:#111;}
      .v-sub{color:#6b7280;font-size:14px;line-height:1.6;}
      .v-main{display:flex;align-items:center;gap:8px;margin-top:6px;}
      .v-main input{transform:scale(1.2);}
      #inspectionModal .modal-card{width:min(560px,92vw);}
      #inspectionText{color:#444;line-height:1.8;padding:12px 18px;}
      #laterBtn{background:#e5e7eb;color:#111;}
      #bookNowBtn{background:var(--primary);color:#fff;}
    </style>
  </head>
  <body>
    <!-- 読み込み -->
    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <p>読み込み中...</p>
    </div>

    <!-- 本文 -->
    <div id="content" class="container" style="display: none">
      <div class="card">
        <div class="header">
          <div class="avatar" id="avatar">👤</div>
          <div class="user-info">
            <h2 id="userName">-</h2>
            <p id="carInfo">-</p>
          </div>
        </div>
        <button class="btn ghost" id="openCarBtn">車両情報を見る</button>
      </div>

      <div class="card">
        <div class="section-title">🔧 次回メンテナンス推奨</div>
        <div id="recommendations"></div>
      </div>

      <div class="card">
        <div class="section-title">📋 整備履歴</div>
        <button class="btn" id="openHistoryBtn">整備履歴を見る</button>
      </div>

      <div class="card">
        <div class="section-title">📏 走行距離の更新</div>
        <div class="row">
          <input id="mileageInput" type="number" inputmode="numeric" placeholder="現在の走行距離 (km)"
            style="flex:1;padding:12px;border:1px solid var(--border);border-radius:10px;" />
          <button class="btn" id="saveMileageBtn" style="width:auto">保存</button>
        </div>
        <p class="badge" style="margin-top:8px;background:#ecfdf5;color:#065f46">
          最新の距離を入れると推奨タイミングが賢くなります
        </p>
      </div>

      <div class="card">
        <div class="section-title">➕ 整備履歴を追加</div>
        <label style="display:block;font-size:14px;color:#1f2937;margin-bottom:6px">整備日</label>
        <div class="date-field" id="dateField">
          <div class="date-icon" id="dateIcon">📅</div>
          <input id="hDate" type="date" class="date-input" placeholder="yyyy-mm-dd" />
        </div>
        <div class="date-hint">カレンダーアイコン または 入力欄をタップして日付を選択してください</div>

        <div style="margin-top:12px;display:grid;gap:8px">
          <select id="hTypeSelect" style="padding:12px;border:1px solid var(--border);border-radius:10px;">
            <option value="" disabled selected>整備項目を選択</option>
            <option>オイル交換</option><option>オイルエレメント交換</option><option>タイヤ交換</option>
            <option>ブレーキフルード交換</option><option>冷却水（LLC）交換</option><option>バッテリー交換</option>
            <option>エアコンフィルター交換</option><option>ワイパーゴム交換</option><option>12ヶ月点検</option>
            <option>車検整備</option><option value="__other__">その他（自由入力）</option>
          </select>
          <input id="hTypeOther" placeholder="その他の内容を入力"
                 style="display:none;padding:12px;border:1px solid var(--border);border-radius:10px;" />
        </div>

        <div class="grid" style="display:grid;gap:8px;margin-top:8px">
          <input id="hDetail" placeholder="例: エンジンオイル交換"
                 style="padding:12px;border:1px solid var(--border);border-radius:10px;" />
          <input id=
