<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1.0,user-scalable=no"
    />
    <title>æ•´å‚™å±¥æ­´ãƒã‚¤ãƒšãƒ¼ã‚¸</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px 20px;
        text-align: center;
      }
      .header h1 {
        font-size: 24px;
        margin-bottom: 10px;
      }
      .content {
        padding: 30px 20px;
      }
      .info-card {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #e0e0e0;
      }
      .info-row:last-child {
        border-bottom: none;
      }
      .info-label {
        font-weight: 600;
        color: #555;
        font-size: 14px;
      }
      .info-value {
        font-size: 16px;
        color: #333;
        font-weight: 500;
      }
      .section-title {
        font-size: 18px;
        font-weight: 700;
        color: #333;
        margin: 30px 0 15px 0;
        padding-bottom: 10px;
        border-bottom: 2px solid #667eea;
      }
      .vehicle-list {
        margin-top: 15px;
      }
      .vehicle-item {
        background: #fff;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
        cursor: pointer;
      }
      .vehicle-item:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
      }
      .vehicle-item.selected {
        border-color: #667eea;
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.1) 0%,
          rgba(118, 75, 162, 0.1) 100%
        );
      }
      .vehicle-header {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }
      .vehicle-radio {
        margin-right: 12px;
        width: 20px;
        height: 20px;
        cursor: pointer;
      }
      .vehicle-name {
        font-size: 18px;
        font-weight: 700;
        color: #333;
      }
      .vehicle-details {
        margin-left: 32px;
        font-size: 14px;
        color: #666;
        line-height: 1.6;
      }
      .btn-primary {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        margin-top: 20px;
        transition: all 0.3s ease;
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      }
      .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }
      .loading {
        text-align: center;
        padding: 40px;
        font-size: 16px;
        color: #667eea;
      }
      .error {
        background: #fee;
        color: #c33;
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        border-left: 4px solid #c33;
      }
      .success {
        background: #efe;
        color: #3c3;
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        border-left: 4px solid #3c3;
      }
      .distance-input-group {
        margin-top: 15px;
        display: flex;
        gap: 10px;
      }
      .distance-input {
        flex: 1;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 16px;
      }
      .distance-input:focus {
        outline: none;
        border-color: #667eea;
      }
      .btn-update-distance {
        padding: 12px 20px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
      }
      .badge {
        display: inline-block;
        padding: 4px 12px;
        background: #667eea;
        color: white;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 10px;
      }
      /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
      #busyOverlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        justify-content: center;
        align-items: center;
      }
      #busyOverlay.show {
        display: flex;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .overlay-content {
        text-align: center;
        color: white;
      }
      .overlay-content p {
        margin-top: 20px;
        font-size: 16px;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <div id="busyOverlay">
      <div class="overlay-content">
        <div class="spinner"></div>
        <p>è»Šä¸¡æƒ…å ±ã‚’æ›´æ–°ä¸­...</p>
      </div>
    </div>

    <div class="container">
      <div class="header">
        <h1>ğŸš— æ•´å‚™å±¥æ­´ãƒã‚¤ãƒšãƒ¼ã‚¸</h1>
        <p>è»Šä¸¡æƒ…å ±ãƒ»ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ç®¡ç†</p>
      </div>

      <div class="content">
        <div id="loading" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        <div id="error" class="error" style="display: none"></div>
        <div id="success" class="success" style="display: none"></div>
        <div id="mainContent" style="display: none">
          <!-- åŸºæœ¬æƒ…å ± -->
          <div class="info-card">
            <div class="info-row">
              <span class="info-label">ãŠåå‰</span>
              <span class="info-value" id="userName">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">é›»è©±ç•ªå·</span>
              <span class="info-value" id="userPhone">-</span>
            </div>
          </div>

          <!-- ãƒ¡ã‚¤ãƒ³è»Šä¸¡æƒ…å ± -->
          <div class="section-title">ğŸš™ ãƒ¡ã‚¤ãƒ³è»Šä¸¡æƒ…å ±</div>
          <div class="info-card">
            <div class="info-row">
              <span class="info-label">è»Šç¨®</span>
              <span class="info-value" id="mainVehicle">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">ãƒŠãƒ³ãƒãƒ¼</span>
              <span class="info-value" id="mainPlate">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">æœ€çµ‚èµ°è¡Œè·é›¢</span>
              <span class="info-value" id="mainDistance">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">è·é›¢æ›´æ–°æ—¥</span>
              <span class="info-value" id="mainDistanceDate">-</span>
            </div>
          </div>

          <!-- èµ°è¡Œè·é›¢æ›´æ–° -->
          <div class="distance-input-group">
            <input
              type="number"
              id="distanceInput"
              class="distance-input"
              placeholder="èµ°è¡Œè·é›¢ã‚’å…¥åŠ› (km)"
            />
            <button class="btn-update-distance" onclick="updateDistance()">
              æ›´æ–°
            </button>
          </div>

          <!-- è»Šä¸¡ä¸€è¦§ -->
          <div class="section-title">ğŸ“‹ ä¿æœ‰è»Šä¸¡ä¸€è¦§</div>
          <div id="vehicleList" class="vehicle-list"></div>

          <button class="btn-primary" onclick="changePrimaryVehicle()">
            é¸æŠã—ãŸè»Šä¸¡ã‚’ãƒ¡ã‚¤ãƒ³ã«è¨­å®š
          </button>
        </div>
      </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
      const GAS_URL =
        "https://script.google.com/macros/s/AKfycbz0EzPRsZ77DFPU8qC555lxya1Zo_KHVRbl_Z32WBKRCIKPb5GCDTgNm7mrhcEUUlDH/exec";
      const LIFF_ID = "2008228464-Jy1OL86j";
      window.POST_TOKEN = "change-me-32chars";

      let userId = null;
      let userData = null;

      // LIFFåˆæœŸåŒ–
      async function initializeLiff() {
        try {
          console.log("LIFFåˆæœŸåŒ–é–‹å§‹: " + LIFF_ID);
          await liff.init({ liffId: LIFF_ID });
          console.log("LIFFåˆæœŸåŒ–æˆåŠŸ");

          if (!liff.isLoggedIn()) {
            console.log("æœªãƒ­ã‚°ã‚¤ãƒ³ â†’ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸");
            liff.login();
            return;
          }

          const profile = await liff.getProfile();
          userId = profile.userId;
          console.log("ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå–å¾—: " + userId);

          await loadUserData();
        } catch (err) {
          console.error("LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", err);
          showError("LIFFã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
        }
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      async function loadUserData() {
        try {
          console.log("ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹...");
          const url = `${GAS_URL}?userId=${encodeURIComponent(userId)}`;
          console.log("ãƒªã‚¯ã‚¨ã‚¹ãƒˆURL: " + url);

          const response = await fetch(url);
          const data = await response.json();
          console.log("ãƒ¬ã‚¹ãƒãƒ³ã‚¹:", data);

          if (data.status === "success") {
            userData = data.data;
            renderUI();
          } else {
            showError("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: " + data.message);
          }
        } catch (err) {
          console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
          showError("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
        }
      }

      // UIæç”»
      function renderUI() {
        document.getElementById("loading").style.display = "none";
        document.getElementById("mainContent").style.display = "block";

        // åŸºæœ¬æƒ…å ±
        document.getElementById("userName").textContent = userData.name || "-";
        document.getElementById("userPhone").textContent =
          userData.phone || "-";

        // ãƒ¡ã‚¤ãƒ³è»Šä¸¡ï¼ˆæœ€åˆã®è»Šä¸¡ï¼‰
        const mainVehicle = userData.vehicles[0];
        document.getElementById("mainVehicle").textContent =
          mainVehicle.vehicle || "-";
        document.getElementById("mainPlate").textContent =
          mainVehicle.plateNumber || "-";
        document.getElementById("mainDistance").textContent =
          mainVehicle.lastDistance ? mainVehicle.lastDistance + " km" : "-";
        document.getElementById("mainDistanceDate").textContent =
          mainVehicle.distanceDate || "-";

        // è»Šä¸¡ä¸€è¦§
        const vehicleListHtml = userData.vehicles
          .map(
            (v, index) => `
      <div class="vehicle-item ${
        index === 0 ? "selected" : ""
      }" onclick="selectVehicle(${index})">
        <div class="vehicle-header">
          <input type="radio" name="vehicleSelect" value="${
            v.row
          }" class="vehicle-radio" 
                 ${
                   index === 0 ? "checked" : ""
                 } onchange="selectVehicle(${index})">
          <span class="vehicle-name">${v.vehicle || "æœªç™»éŒ²"}</span>
          ${index === 0 ? '<span class="badge">ãƒ¡ã‚¤ãƒ³</span>' : ""}
        </div>
        <div class="vehicle-details">
          <div>ğŸ“Œ ãƒŠãƒ³ãƒãƒ¼: ${v.plateNumber || "-"}</div>
          <div>ğŸ“ èµ°è¡Œè·é›¢: ${
            v.lastDistance ? v.lastDistance + " km" : "-"
          }</div>
          <div>ğŸ“… æ›´æ–°æ—¥: ${v.distanceDate || "-"}</div>
        </div>
      </div>
    `
          )
          .join("");

        document.getElementById("vehicleList").innerHTML = vehicleListHtml;
      }

      // è»Šä¸¡é¸æŠ
      function selectVehicle(index) {
        const items = document.querySelectorAll(".vehicle-item");
        items.forEach((item, i) => {
          if (i === index) {
            item.classList.add("selected");
          } else {
            item.classList.remove("selected");
          }
        });
      }

      // ãƒ¡ã‚¤ãƒ³è»Šä¸¡å¤‰æ›´
      async function changePrimaryVehicle() {
        const selectedRadio = document.querySelector(
          'input[name="vehicleSelect"]:checked'
        );

        if (!selectedRadio) {
          showError("è»Šä¸¡ã‚’é¸æŠã—ã¦ãã ã•ã„");
          return;
        }

        const selectedRow = Number(selectedRadio.value);
        console.log("é¸æŠã•ã‚ŒãŸè¡Œç•ªå·: " + selectedRow);

        // æ—¢ã«ãƒ¡ã‚¤ãƒ³è»Šä¸¡ã®å ´åˆ
        if (
          selectedRadio ===
          document.querySelector('input[name="vehicleSelect"]')
        ) {
          const firstRadio = document.querySelector(
            'input[name="vehicleSelect"]'
          );
          if (selectedRadio.value === firstRadio.value) {
            showError("æ—¢ã«ãƒ¡ã‚¤ãƒ³è»Šä¸¡ã§ã™");
            return;
          }
        }

        showBusyOverlay();

        try {
          console.log("è»Šä¸¡åˆ‡ã‚Šæ›¿ãˆãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡...");

          const requestData = {
            action: "setPrimaryVehicle",
            userId: userId,
            row: selectedRow,
            token: window.POST_TOKEN,
          };

          console.log("é€ä¿¡ãƒ‡ãƒ¼ã‚¿:", requestData);

          const response = await fetch(GAS_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
          });

          console.log("ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:", response.status);

          const result = await response.json();
          console.log("ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿:", result);

          hideBusyOverlay();

          if (result.status === "success") {
            showSuccess("ãƒ¡ã‚¤ãƒ³è»Šä¸¡ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¾ã™...");
            setTimeout(() => {
              location.reload();
            }, 1500);
          } else {
            showError("æ›´æ–°ã‚¨ãƒ©ãƒ¼: " + result.message);
          }
        } catch (err) {
          hideBusyOverlay();
          console.error("è»Šä¸¡åˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼:", err);
          showError("è»Šä¸¡ã®åˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
        }
      }

      // èµ°è¡Œè·é›¢æ›´æ–°
      async function updateDistance() {
        const distanceInput = document.getElementById("distanceInput");
        const distance = parseInt(distanceInput.value);

        if (!distance || distance <= 0) {
          showError("æœ‰åŠ¹ãªèµ°è¡Œè·é›¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
          return;
        }

        const mainVehicle = userData.vehicles[0];
        const mainRow = mainVehicle.row;

        showBusyOverlay();

        try {
          console.log("èµ°è¡Œè·é›¢æ›´æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡...");

          const requestData = {
            action: "updateDistance",
            userId: userId,
            row: mainRow,
            distance: distance,
            token: window.POST_TOKEN,
          };

          const response = await fetch(GAS_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
          });

          const result = await response.json();
          console.log("èµ°è¡Œè·é›¢æ›´æ–°çµæœ:", result);

          hideBusyOverlay();

          if (result.status === "success") {
            showSuccess("èµ°è¡Œè·é›¢ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¾ã™...");
            setTimeout(() => {
              location.reload();
            }, 1500);
          } else {
            showError("æ›´æ–°ã‚¨ãƒ©ãƒ¼: " + result.message);
          }
        } catch (err) {
          hideBusyOverlay();
          console.error("èµ°è¡Œè·é›¢æ›´æ–°ã‚¨ãƒ©ãƒ¼:", err);
          showError("èµ°è¡Œè·é›¢ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
        }
      }

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º
      function showBusyOverlay() {
        document.getElementById("busyOverlay").classList.add("show");
      }

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤éè¡¨ç¤º
      function hideBusyOverlay() {
        document.getElementById("busyOverlay").classList.remove("show");
      }

      // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
      function showError(message) {
        const errorDiv = document.getElementById("error");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
        document.getElementById("success").style.display = "none";
        setTimeout(() => {
          errorDiv.style.display = "none";
        }, 5000);
      }

      // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
      function showSuccess(message) {
        const successDiv = document.getElementById("success");
        successDiv.textContent = message;
        successDiv.style.display = "block";
        document.getElementById("error").style.display = "none";
        setTimeout(() => {
          successDiv.style.display = "none";
        }, 3000);
      }

      // åˆæœŸåŒ–å®Ÿè¡Œ
      initializeLiff();
    </script>
  </body>
</html>
